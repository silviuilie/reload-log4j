<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Log4jUtilityServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">reload-log4j</a> &gt; <a href="index.source.html" class="el_package">eu.pm.tools.log4j.servlet</a> &gt; <span class="el_source">Log4jUtilityServlet.java</span></div><h1>Log4jUtilityServlet.java</h1><pre class="source lang-java linenums">package eu.pm.tools.log4j.servlet;


import eu.pm.tools.log4j.Log4jApplicationContext;
import eu.pm.tools.log4j.Log4jUtility;
import eu.pm.tools.log4j.ReloadAuthorization;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletConfig;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.Constructor;

import static eu.pm.tools.log4j.Log4jUtility.*;
import static org.apache.commons.lang.StringUtils.isNotEmpty;

/**
 * Created by silviu
 * Date: 13/02/14 / 22:14279
 * &lt;p&gt;
 * services {@link eu.pm.tools.log4j.Log4jUtility}.
 * &lt;/p&gt;
 * &lt;br/&gt;
 *
 * @author Silviu Ilie
 */
<span class="fc" id="L33">public class Log4jUtilityServlet extends HttpServlet {</span>

    private static final String DEFAULT_JSP_LOCATION = &quot;/WEB-INF/jsp/&quot;;

    /**
     * jsp location.
     */
<span class="fc" id="L40">    private String jspLocation = DEFAULT_JSP_LOCATION;</span>


    /**
     * log4j tools.
     */
<span class="fc" id="L46">    private Log4jUtility log4jUtility = new Log4jUtility();</span>

    /**
     * handles all GET requests, if  URI is not expected redirect to home.
     *
     * @param req  request
     * @param resp response
     * @throws ServletException
     * @throws IOException
     */
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

<span class="fc" id="L59">        copyParameters(req);</span>

<span class="fc" id="L61">        String requestName = req.getRequestURI();</span>

        // when expected URI requested and authorized, go home.
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (requestName.contains(LOG4J_UTILITY_HOME_URL)</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">                &amp;&amp; log4jUtility.isAuthorized(req.getSession())) {</span>

<span class="fc" id="L67">            ServletContext context = getServletContext();</span>
<span class="fc" id="L68">            RequestDispatcher dispatcher = context.getRequestDispatcher(jspLocation + &quot;log4jlevelReload.jsp&quot;);</span>
<span class="fc" id="L69">            dispatcher.forward(req, resp);</span>
<span class="fc" id="L70">            return;</span>

        }
<span class="fc" id="L73">        resp.sendRedirect(req.getContextPath());</span>
<span class="fc" id="L74">    }</span>


    /**
     * handles all POST requests, if  URI is not expected redirect to home.
     *
     * @param req  request
     * @param resp response
     * @throws ServletException
     * @throws IOException
     */

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

<span class="fc" id="L89">        String requestName = req.getRequestURI();</span>

        // when expected URI requested and authorized, find class.
<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (requestName.contains(LOG4J_UTILITY_FIND_CLASS_URL)</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">                &amp;&amp; log4jUtility.isAuthorized(req.getSession())) {</span>
<span class="fc" id="L94">            resp.getWriter().write(</span>
<span class="fc" id="L95">                    log4jUtility.log4jFindClass(req.getParameter(&quot;name&quot;), req.getSession())</span>
            );
        }

        // when expected URI requested and authorized, set priority
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (requestName.contains(LOG4J_UTILITY_RELOAD_URL)</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">                &amp;&amp; log4jUtility.isAuthorized(req.getSession())) {</span>
<span class="fc" id="L102">            resp.getWriter().write(</span>
<span class="fc" id="L103">                    log4jUtility.setPriority(</span>
<span class="fc" id="L104">                            req.getParameter(&quot;target&quot;),</span>
<span class="fc" id="L105">                            req.getParameter(&quot;priority&quot;),</span>
<span class="fc" id="L106">                            req.getSession())</span>
            );
        }
<span class="fc" id="L109">    }</span>


    /**
     * handle configuration.
     *
     * @param config container provided.
     * @throws ServletException
     */
    @Override
    public void init(ServletConfig config) throws ServletException {
<span class="fc" id="L120">        super.init(config);</span>

<span class="fc" id="L122">        ServletContext ctx = config.getServletContext();</span>

<span class="fc" id="L124">        final String jspLocation = ctx.getInitParameter(Log4jUtility.LOG4J_UTILITY_JSP_LOCATION_ATTR_NAME);</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (jspLocation == null) {</span>
<span class="nc" id="L126">            log.warn(&quot;log4j-jsp-location parameter not found, using default &quot; + DEFAULT_JSP_LOCATION);</span>
        } else {
<span class="fc" id="L128">            this.jspLocation = jspLocation;</span>
        }

<span class="fc" id="L131">        final String packageName = ctx.getInitParameter(Log4jUtility.LOG4J_UTILITY_PACKAGE_ATTR_NAME);</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        if (packageName == null) {</span>
<span class="nc" id="L133">            throw new RuntimeException(&quot;log4j-base-packageName parameter is required.&quot;);</span>
        }

<span class="fc" id="L136">        final String authorizationClassName = ctx.getInitParameter(Log4jUtility.LOG4J_UTILITY_AUTH_ATTR_NAME);</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (authorizationClassName == null) {</span>
<span class="nc" id="L138">            log.warn(&quot;log4j-authorization-class parameter not found, using default&quot;);</span>
        }

        ReloadAuthorization log4jUtilityAuthorization;

<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (isNotEmpty(authorizationClassName)) {</span>
            try {


                @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L148">                Class&lt;ReloadAuthorization&gt; authorizationClass = (Class&lt;ReloadAuthorization&gt;)</span>
<span class="fc" id="L149">                        Class.forName(authorizationClassName);</span>

<span class="fc" id="L151">                Constructor&lt;ReloadAuthorization&gt; authClassConstructor = authorizationClass.getDeclaredConstructor();</span>
<span class="fc" id="L152">                log4jUtilityAuthorization = authClassConstructor.newInstance();</span>

<span class="nc" id="L154">            } catch (Throwable e) {</span>
<span class="nc" id="L155">                log.warn(authorizationClassName + &quot; not found.using default : &quot;</span>
                        + Log4jApplicationContext.DEFAULT_AUTHORIZATION);
<span class="nc" id="L157">                log.error(authorizationClassName + &quot; not found&quot;, e);</span>
<span class="nc" id="L158">                log4jUtilityAuthorization = Log4jApplicationContext.DEFAULT_AUTHORIZATION;</span>
<span class="pc" id="L159">            }</span>

        } else {
<span class="nc" id="L162">            log.warn(&quot;using default authorization &quot; + Log4jApplicationContext.DEFAULT_AUTHORIZATION);</span>
<span class="nc" id="L163">            log4jUtilityAuthorization = Log4jApplicationContext.DEFAULT_AUTHORIZATION;</span>
        }

<span class="fc" id="L166">        log4jUtility.setApplicationContext(new Log4jApplicationContext(packageName, log4jUtilityAuthorization));</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L169">            log.debug(&quot;=====================================&quot;);</span>
<span class="nc" id="L170">            log.debug(&quot;log4j reloader available as /&quot; + Log4jUtility.LOG4J_UTILITY_HOME_URL);</span>
<span class="nc" id="L171">            log.debug(&quot;=====================================&quot;);</span>
        }

<span class="fc" id="L174">    }</span>

    private void copyParameters(HttpServletRequest req) {
<span class="fc" id="L177">        ServletContext ctx = req.getSession().getServletContext();</span>
<span class="fc" id="L178">        req.setAttribute(Log4jUtility.LOG4J_UTILITY_HOME_URL, ctx.getInitParameter(Log4jUtility.LOG4J_UTILITY_HOME_URL));</span>
<span class="fc" id="L179">        req.setAttribute(Log4jUtility.LOG4J_UTILITY_FIND_CLASS_URL, ctx.getInitParameter(Log4jUtility.LOG4J_UTILITY_FIND_CLASS_URL));</span>
<span class="fc" id="L180">        req.setAttribute(Log4jUtility.LOG4J_UTILITY_RELOAD_URL, ctx.getInitParameter(Log4jUtility.LOG4J_UTILITY_RELOAD_URL));</span>
<span class="fc" id="L181">    }</span>


    /**
     * used in tests.
     *
     * @param log4jUtility {@link Log4jUtility}.
     */
    void setLog4jUtility(Log4jUtility log4jUtility) {
<span class="fc" id="L190">        this.log4jUtility = log4jUtility;</span>
<span class="fc" id="L191">    }</span>

    /**
     * log
     */
<span class="fc" id="L196">    private Log log = LogFactory.getLog(this.getClass());</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>